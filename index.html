<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Attendance System</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #2563eb; --success: #059669; --error: #dc2626; }
        body { font-family: 'Inter', system-ui, sans-serif; background: #f8fafc; display: flex; justify-content: center; padding: 20px; margin: 0; }
        .card { background: white; width: 100%; max-width: 500px; padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.05); text-align: center; }
        h1 { color: #1e293b; margin-bottom: 0.5rem; font-size: 1.5rem; }
        #reader { width: 100%; border-radius: 0.75rem; overflow: hidden; border: 2px solid #e2e8f0; background: #000; }
        #status { margin-top: 1.5rem; padding: 1rem; border-radius: 0.5rem; font-weight: 600; min-height: 24px; transition: all 0.3s ease; }
        .idle { background: #f1f5f9; color: #64748b; }
        .processing { background: #fef3c7; color: #92400e; }
        .msg-success { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .msg-error { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        button { background: var(--primary); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; margin-top: 1rem; width: 100%; }
        button:hover { opacity: 0.9; }
        #reader video { object-fit: cover !important; } /* Fix for iPhone display */
    </style>
</head>
<body>

<div class="card">
    <h1>Attendance Scanner</h1>
    <p style="color: #64748b; font-size: 0.9rem;">Position QR code within the frame</p>
    
    <button id="start-btn" onclick="startScanner()">Start Camera</button>
    
    <div id="reader"></div>
    <div id="status" class="idle">System Ready</div>
</div>

<script>
    // 1. UPDATE THIS URL with your latest Deployment URL from Google Apps Script
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwDQ461fN4WaHNwMlt_kjewVcS9z1KW8as-_DmdaYWcgKdAznxx0oxeLbFNh3NW3gtE/exec";

    let scanner;

    function startScanner() {
        document.getElementById('start-btn').style.display = 'none';
        
        scanner = new Html5Qrcode("reader");
        
        const config = { 
            fps: 15, 
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0 
        };

        // Start using the back camera (environment)
        scanner.start({ facingMode: "environment" }, config, onScanSuccess)
        .catch(err => {
            console.error(err);
            setStatus("Camera Error: Please allow permissions.", "msg-error");
            document.getElementById('start-btn').style.display = 'block';
        });
    }

    async function onScanSuccess(decodedText) {
        // Stop scanning immediately to prevent duplicate sends
        scanner.pause(true);
        
        setStatus("Syncing with Google Sheets...", "processing");

        try {
            // Using no-cors to bypass Google's redirect security blocks
            await fetch(SCRIPT_URL, {
                method: "POST",
                mode: "no-cors",
                body: decodedText,
                headers: { "Content-Type": "text/plain" }
            });

            // If it gets here without a catch, the data was sent
            setStatus("Success! Entry/Exit Recorded.", "msg-success");
            
            // Wait 4 seconds then reset for next person
            setTimeout(() => {
                setStatus("Ready for next scan", "idle");
                scanner.resume();
            }, 4000);

        } catch (error) {
            console.error(error);
            setStatus("Connection Error. Try again.", "msg-error");
            setTimeout(() => scanner.resume(), 3000);
        }
    }

    function setStatus(text, className) {
        const s = document.getElementById('status');
        s.innerText = text;
        s.className = className;
    }
</script>

</body>
</html>
